import { GoogleGenerativeAI } from "@google/generative-ai";

const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

// API_KEYê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
let genAI = null;
if (API_KEY) {
  try {
    genAI = new GoogleGenerativeAI(API_KEY);
  } catch (error) {
    console.error('Gemini AI ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
  }
}

export async function analyzeCard(imageBlob) {
  try {
    // API_KEY í™•ì¸
    if (!API_KEY || !genAI) {
      throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¶€ëª¨ ëª¨ë“œì—ì„œ API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
    }

    // gemini-2.5-flash ëª¨ë¸ ì‚¬ìš© - ê²€ì¦ ì™„ë£Œëœ ìµœì‹  ì•ˆì • ë²„ì „ (ì •í™•ë„ í–¥ìƒ)
    // gemini-1.5 ë²„ì „ì€ ì‘ë™í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ 2.0/2.5 ë²„ì „ ì‚¬ìš©
    // gemini-2.5-flashëŠ” ìµœì‹  ë²„ì „ìœ¼ë¡œ ì •í™•ë„ê°€ ë†’ìŒ
    const model = genAI.getGenerativeModel({ 
      model: "gemini-2.5-flash",
      generationConfig: {
        temperature: 0.1, // ë‚®ì€ ì˜¨ë„ë¡œ ë” ì •í™•í•˜ê³  ì¼ê´€ëœ ì‘ë‹µ
        topP: 0.95,
        topK: 40,
      }
    });

    const base64Data = await blobToBase64(imageBlob);

    // 1ë‹¨ê³„: í¬ì¼“ëª¬ ì¹´ë“œì¸ì§€ ë¨¼ì € í™•ì¸ (ë” ìƒì„¸í•œ ê²€ì¦)
    const validationPrompt = `ë‹¹ì‹ ì€ í¬ì¼“ëª¬ ì¹´ë“œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë§¤ìš° ì‹ ì¤‘í•˜ê²Œ ê²€í† í•˜ì—¬ ì´ê²ƒì´ í¬ì¼“ëª¬ íŠ¸ë ˆì´ë”© ì¹´ë“œ ê²Œì„(Pokemon TCG)ì˜ ê³µì‹ í¬ì¼“ëª¬ ì¹´ë“œì¸ì§€ ì •í™•íˆ íŒë‹¨í•´ì£¼ì„¸ìš”.

**í¬ì¼“ëª¬ ì¹´ë“œì˜ ëª…í™•í•œ íŠ¹ì§•:**
1. ìƒë‹¨ ë˜ëŠ” í•˜ë‹¨ì— "Pokemon" ë˜ëŠ” "Pokemon Company" ë¡œê³ /ë¸Œëœë”©
2. ì¹´ë“œ ì™¼ìª½ ìƒë‹¨ ë˜ëŠ” ì¤‘ì•™ì— HP(ì²´ë ¥) ìˆ«ì í‘œì‹œ (ì˜ˆ: "HP 60", "HP 120")
3. ì¹´ë“œ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— íƒ€ì… ì•„ì´ì½˜/ì‹¬ë³¼ (ë¶ˆê½ƒğŸ”¥, ë¬¼ğŸ’§, í’€ğŸŒ¿, ì „ê¸°âš¡ ë“±)
4. ì¹´ë“œ ì¤‘ì•™ì— í¬ì¼“ëª¬ ìºë¦­í„° ì¼ëŸ¬ìŠ¤íŠ¸ (í”¼ì¹´ì¶”, íŒŒì´ë¦¬, ê¼¬ë¶€ê¸° ë“±)
5. í•˜ë‹¨ì— í¬ì¼“ëª¬ ì´ë¦„ì´ í•œêµ­ì–´ ë˜ëŠ” ì˜ì–´ë¡œ ëª…í™•íˆ í‘œì‹œ
6. ì¹´ë“œ ê²Œì„ íŠ¹ìœ ì˜ ì§ì‚¬ê°í˜• ë ˆì´ì•„ì›ƒ (ì•½ 2.5:3.5 ë¹„ìœ¨)
7. ì¹´ë“œ í…Œë‘ë¦¬ì™€ í”„ë ˆì„ ë””ìì¸

**í¬ì¼“ëª¬ ì¹´ë“œê°€ ì•„ë‹Œ ê²½ìš°:**
- ì¼ë°˜ ì‚¬ì§„, ê·¸ë¦¼, ë§Œí™”ì±… í˜ì´ì§€
- ë‹¤ë¥¸ TCG ì¹´ë“œ (ìœ í¬ì™•, ë§¤ì§ ë” ê²Œë”ë§, ë² ì´ë¸”ë ˆì´ë“œ ë“±)
- í¬ì¼“ëª¬ ê´€ë ¨ ìƒí’ˆ, ì¥ë‚œê°, í”¼ê·œì–´ ì‚¬ì§„
- í¬ì¼“ëª¬ì´ ê·¸ë ¤ì§„ ì¼ëŸ¬ìŠ¤íŠ¸ë‚˜ íŒ¬ì•„íŠ¸
- í¬ì¼“ëª¬ ì˜í™”/ì• ë‹ˆë©”ì´ì…˜ ìŠ¤í¬ë¦°ìƒ·

**ì¤‘ìš”:** ì´ë¯¸ì§€ë¥¼ ê¼¼ê¼¼íˆ ì‚´í´ë³´ê³  ìœ„ íŠ¹ì§•ë“¤ì„ ëª¨ë‘ í™•ì¸í•œ í›„ íŒë‹¨í•˜ì„¸ìš”.

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš” (ì„¤ëª… ì—†ì´ JSONë§Œ):
{
  "isPokemonCard": true ë˜ëŠ” false,
  "reason": "í¬ì¼“ëª¬ ì¹´ë“œì¸ ì´ìœ  ë˜ëŠ” ì•„ë‹Œ ì´ìœ ë¥¼ í•œêµ­ì–´ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…"
}`;

    const imagePart = {
      inlineData: {
        data: base64Data,
        mimeType: imageBlob.type,
      },
    };

    // 1ë‹¨ê³„: ì¹´ë“œ ê²€ì¦
    const validationResult = await model.generateContent([validationPrompt, imagePart]);
    const validationResponse = validationResult.response;
    let validationText = validationResponse.text();
    
    // JSON ì¶”ì¶œ ê°œì„  - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ì´ë‚˜ ì„¤ëª… ì œê±°
    validationText = validationText.trim();
    // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
    validationText = validationText.replace(/```json\s*/g, '').replace(/```\s*/g, '');
    // JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ
    const validationJsonMatch = validationText.match(/\{[\s\S]*\}/);

    if (!validationJsonMatch) {
      console.error('ê²€ì¦ ì‘ë‹µ ì›ë¬¸:', validationText);
      throw new Error("ì¹´ë“œ ê²€ì¦ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    let validation;
    try {
      validation = JSON.parse(validationJsonMatch[0]);
    } catch (parseError) {
      console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
      console.error('íŒŒì‹± ì‹œë„í•œ í…ìŠ¤íŠ¸:', validationJsonMatch[0]);
      throw new Error("ì¹´ë“œ ê²€ì¦ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.");
    }

    // í¬ì¼“ëª¬ ì¹´ë“œê°€ ì•„ë‹ˆë©´ ì—ëŸ¬ ë°œìƒ
    if (!validation.isPokemonCard) {
      const reason = validation.reason || "ëª¬ìŠ¤í„° ì¹´ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.";
      throw new Error(`ëª¬ìŠ¤í„° ì¹´ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”. ${reason}`);
    }

    // ë¹„ê³µì‹/ìœ„ì¡° ì¹´ë“œ ì—¬ë¶€ ì €ì¥ (ë‚´ë¶€ì ìœ¼ë¡œë§Œ ì‚¬ìš©, UIì—ëŠ” í‘œì‹œ ì•ˆ í•¨)
    const isOfficial = validation.isOfficial !== false; // ê¸°ë³¸ê°’ì€ true

    // 2ë‹¨ê³„: í¬ì¼“ëª¬ ì¹´ë“œ ìƒì„¸ ë¶„ì„ (ì •í™•ë„ í–¥ìƒì„ ìœ„í•œ ìƒì„¸ í”„ë¡¬í”„íŠ¸)
    const analysisPrompt = `ë‹¹ì‹ ì€ í¬ì¼“ëª¬ ì¹´ë“œ ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í¬ì¼“ëª¬ ì¹´ë“œ ì´ë¯¸ì§€ë¥¼ ë§¤ìš° ì •í™•í•˜ê²Œ ë¶„ì„í•˜ì—¬ ì•„ë˜ ì •ë³´ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ë¶„ì„ ì‹œ ì£¼ì˜ì‚¬í•­:**
1. ì¹´ë“œì˜ ëª¨ë“  í…ìŠ¤íŠ¸ì™€ ìˆ«ìë¥¼ ì •í™•íˆ ì½ì–´ì£¼ì„¸ìš”
2. ì¹´ë“œ ì´ë¯¸ì§€ë¥¼ ê¼¼ê¼¼íˆ ê´€ì°°í•˜ì—¬ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”
3. ì¶”ì¸¡í•˜ì§€ ë§ê³  ì¹´ë“œì— ì‹¤ì œë¡œ í‘œì‹œëœ ì •ë³´ë§Œ ì‚¬ìš©í•˜ì„¸ìš”

**ê° í•„ë“œë³„ ë¶„ì„ ê°€ì´ë“œ:**

**1. name (í¬ì¼“ëª¬ ì´ë¦„)**
- ì¹´ë“œ ìƒë‹¨ ë˜ëŠ” ì¤‘ì•™ì— í‘œì‹œëœ í¬ì¼“ëª¬ì˜ ì •í™•í•œ ì´ë¦„
- í•œêµ­ì–´ë¡œ í‘œì‹œëœ ê²½ìš° í•œêµ­ì–´ ì´ë¦„ ì‚¬ìš©
- ì˜ì–´ë¡œë§Œ í‘œì‹œëœ ê²½ìš° í•œêµ­ì–´ë¡œ ë²ˆì—­ (ì˜ˆ: "Pikachu" â†’ "í”¼ì¹´ì¶”")
- ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±, ì˜ì–´ ì‚¬ìš© ê¸ˆì§€

**2. hp (ì²´ë ¥)**
- ì¹´ë“œ ì™¼ìª½ ìƒë‹¨ ë˜ëŠ” ì¤‘ì•™ì— í‘œì‹œëœ "HP 60", "HP 120" ë“±ì˜ ìˆ«ì ê°’
- ì •í™•íˆ ì½ì–´ì„œ ìˆ«ìë§Œ ë°˜í™˜ (ì˜ˆ: 60, 120, 200)
- ì¶”ì¸¡í•˜ì§€ ë§ê³  ì‹¤ì œ ì¹´ë“œì— í‘œì‹œëœ ìˆ«ìë§Œ ì‚¬ìš©

**3. type (íƒ€ì…)**
- ì¹´ë“œ ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ íƒ€ì… ì•„ì´ì½˜/ì‹¬ë³¼ì„ í™•ì¸
- ë‹¤ìŒ ì¤‘ ì •í™•íˆ í•˜ë‚˜ë¥¼ ì„ íƒ (ë°˜ë“œì‹œ í•œêµ­ì–´): "ë…¸ë§", "ë¶ˆê½ƒ", "ë¬¼", "ì „ê¸°", "í’€", "ì–¼ìŒ", "ê²©íˆ¬", "ë…", "ë•…", "ë¹„í–‰", "ì—ìŠ¤í¼", "ë²Œë ˆ", "ë°”ìœ„", "ê³ ìŠ¤íŠ¸", "ë“œë˜ê³¤", "ì•…", "ê°•ì² ", "í˜ì–´ë¦¬"
- íƒ€ì… ì•„ì´ì½˜ì˜ ìƒ‰ìƒê³¼ ëª¨ì–‘ì„ ì •í™•íˆ ì‹ë³„

**4. rarity (í¬ê·€ë„)**
- ì¹´ë“œ í•˜ë‹¨ì˜ í¬ê·€ë„ í‘œì‹œ í™•ì¸
- 1 = ì¼ë°˜ ì¹´ë“œ (ë³„í‘œ ì—†ìŒ ë˜ëŠ” í°ìƒ‰ ë³„)
- 2 = ì–¸ì»¤ë¨¼ ì¹´ë“œ (1ê°œ ë³„)
- 3 = ë ˆì–´ ì¹´ë“œ (2ê°œ ë³„)
- 4 = ì—˜ë¦¬íŠ¸ ë ˆì–´/ìš¸íŠ¸ë¼ ë ˆì–´ (3ê°œ ë³„ ë˜ëŠ” íŠ¹ë³„ í‘œì‹œ)
- 5 = ì „ì„¤/ì‹œí¬ë¦¿ ë ˆì–´ (4ê°œ ë³„ ì´ìƒ ë˜ëŠ” íŠ¹ë³„ í‘œì‹œ)
- ì¹´ë“œì˜ ì‹¤ì œ í¬ê·€ë„ í‘œì‹œë¥¼ í™•ì¸í•˜ì—¬ íŒë‹¨

**5. description (ì„¤ëª…)**
- ì¹´ë“œì— í‘œì‹œëœ í¬ì¼“ëª¬ì˜ íŠ¹ì„±ì´ë‚˜ ëŠ¥ë ¥ ì„¤ëª…
- ì—†ìœ¼ë©´ í¬ì¼“ëª¬ ì´ë¦„ì„ ë°”íƒ•ìœ¼ë¡œ ê°„ë‹¨íˆ ì‘ì„±
- í•œêµ­ì–´ë¡œ 50ì ì´ë‚´

**6. powerLevel (ê°•ë ¥í•¨ ìˆ˜ì¹˜)**
- HP, í¬ê·€ë„, ê¸°ìˆ  ë“±ì„ ì¢…í•©í•˜ì—¬ 1~100 ì‚¬ì´ ìˆ«ìë¡œ í‰ê°€
- HPê°€ ë†’ì„ìˆ˜ë¡, í¬ê·€ë„ê°€ ë†’ì„ìˆ˜ë¡, ê°•ë ¥í•œ ê¸°ìˆ ì´ ìˆì„ìˆ˜ë¡ ë†’ì€ ìˆ˜ì¹˜
- ì˜ˆ: HP 60 + í¬ê·€ë„ 2 = ì•½ 40-50, HP 200 + í¬ê·€ë„ 5 = 90-100

**7. strongAgainst (ê°•ì  íƒ€ì…)**
- í¬ì¼“ëª¬ íƒ€ì… ìƒì„±í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê°•ì  íƒ€ì…
- ì˜ˆ: ë¶ˆê½ƒ íƒ€ì… â†’ "í’€" ë˜ëŠ” "ë²Œë ˆ" ë˜ëŠ” "ì–¼ìŒ"
- í•œêµ­ì–´ íƒ€ì… ì´ë¦„ìœ¼ë¡œ ì‘ì„±

**8. weakAgainst (ì•½ì  íƒ€ì…)**
- í¬ì¼“ëª¬ íƒ€ì… ìƒì„±í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì•½ì  íƒ€ì…
- ì˜ˆ: ë¶ˆê½ƒ íƒ€ì… â†’ "ë¬¼" ë˜ëŠ” "ë•…" ë˜ëŠ” "ë°”ìœ„"
- í•œêµ­ì–´ íƒ€ì… ì´ë¦„ìœ¼ë¡œ ì‘ì„±

**9. nickname (ë³„ëª…)**
- í¬ì¼“ëª¬ ì´ë¦„ì„ ë°”íƒ•ìœ¼ë¡œ ê·€ì—¬ìš´ í•œêµ­ì–´ ë³„ëª…
- ì˜ˆ: "í”¼ì¹´ì¶”" â†’ "ë²ˆê°œê³µì£¼", "íŒŒì´ë¦¬" â†’ "ë¶ˆê½ƒì•…ì–´"
- ì„ íƒì‚¬í•­ì´ì§€ë§Œ ê°€ëŠ¥í•˜ë©´ ì‘ì„±

**ì¤‘ìš” ê·œì¹™:**
- ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ì„± (ì˜ì–´ ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€)
- JSON í˜•ì‹ë§Œ ë°˜í™˜í•˜ê³  ì„¤ëª…ì´ë‚˜ ì¶”ê°€ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”
- ì¹´ë“œì— í‘œì‹œëœ ì •ë³´ë§Œ ì‚¬ìš©í•˜ê³  ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”
- ìˆ«ìëŠ” ì •ìˆ˜ë¡œë§Œ ì‘ì„± (ì˜ˆ: 60, 120)

ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”:
{ 
  "name": "í¬ì¼“ëª¬ ì´ë¦„ (í•œêµ­ì–´)", 
  "hp": ìˆ«ì, 
  "type": "íƒ€ì… (í•œêµ­ì–´)", 
  "rarity": 1~5 ì‚¬ì´ ìˆ«ì, 
  "description": "ì„¤ëª… (í•œêµ­ì–´, 50ì ì´ë‚´)", 
  "powerLevel": 1~100 ì‚¬ì´ ìˆ«ì, 
  "strongAgainst": "ê°•ì  íƒ€ì… (í•œêµ­ì–´)", 
  "weakAgainst": "ì•½ì  íƒ€ì… (í•œêµ­ì–´)", 
  "nickname": "ë³„ëª… (í•œêµ­ì–´)" 
}`;

    const analysisResult = await model.generateContent([analysisPrompt, imagePart]);
    const analysisResponse = analysisResult.response;
    let analysisText = analysisResponse.text();
    
    // JSON ì¶”ì¶œ ê°œì„  - ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ì´ë‚˜ ì„¤ëª… ì œê±°
    analysisText = analysisText.trim();
    // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
    analysisText = analysisText.replace(/```json\s*/g, '').replace(/```\s*/g, '');
    // JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ
    const analysisJsonMatch = analysisText.match(/\{[\s\S]*\}/);

    if (!analysisJsonMatch) {
      console.error('ë¶„ì„ ì‘ë‹µ ì›ë¬¸:', analysisText);
      throw new Error("ë¶„ì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë“œë¥¼ ëª…í™•í•˜ê²Œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.");
    }

    let result;
    try {
      result = JSON.parse(analysisJsonMatch[0]);
    } catch (parseError) {
      console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
      console.error('íŒŒì‹± ì‹œë„í•œ í…ìŠ¤íŠ¸:', analysisJsonMatch[0]);
      throw new Error("ì¹´ë“œ ë¶„ì„ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.");
    }

    // ê²°ê³¼ ê²€ì¦
    if (!result.name || !result.hp || !result.type) {
      throw new Error("ì¹´ë“œ ë¶„ì„ ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. ëª¬ìŠ¤í„° ì¹´ë“œë¥¼ ëª…í™•í•˜ê²Œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.");
    }

    // ë¹„ê³µì‹/ìœ„ì¡° ì¹´ë“œ ì—¬ë¶€ë¥¼ ê²°ê³¼ì— ì¶”ê°€ (ë‚´ë¶€ì ìœ¼ë¡œë§Œ ì‚¬ìš©, UIì—ëŠ” í‘œì‹œ ì•ˆ í•¨)
    result._isOfficial = isOfficial; // _ ì ‘ë‘ì‚¬ë¡œ ë‚´ë¶€ ì „ìš©ì„ì„ í‘œì‹œ

    return result;

  } catch (error) {
    console.error("ë¶„ì„ ì—ëŸ¬ ë°œìƒ:", error);

    // ì‚¬ìš©ì ì¹œí™”ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€
    if (error.message.includes("ëª¬ìŠ¤í„° ì¹´ë“œ") || error.message.includes("í¬ì¼“ëª¬ ì¹´ë“œ")) {
      throw error; // ëª¬ìŠ¤í„° ì¹´ë“œê°€ ì•„ë‹ˆë¼ëŠ” ì—ëŸ¬ëŠ” ê·¸ëŒ€ë¡œ ì „ë‹¬
    }

    // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì—ëŸ¬ ì²˜ë¦¬
    if (error.message.includes("429") || error.message.includes("quota") || error.message.includes("Quota exceeded")) {
      const retryMatch = error.message.match(/Please retry in (\d+)/);
      const retrySeconds = retryMatch ? parseInt(retryMatch[1]) : 60;
      const retryMinutes = Math.ceil(retrySeconds / 60);

      throw new Error(`ì˜¤ëŠ˜ ì¹´ë“œ ë¶„ì„ í• ë‹¹ëŸ‰ì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”. ${retryMinutes}ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”! ğŸ•`);
    }

    // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ ì²˜ë¦¬
    if (error.message.includes("fetch") || error.message.includes("network") || error.name === "TypeError") {
      throw new Error(`ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message})`);
    }

    // ê¸°íƒ€ ì—ëŸ¬
    throw new Error(`ì¹´ë“œ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
  }
}

function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}